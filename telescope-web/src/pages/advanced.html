<html>

<head>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/style.css">
    <title>Telescope Advanced Test</title>
</head>

<body>
    <nav>
        <a class="brand" href="/">Telescope</a>
        <div class="tabs" part="tabs">
            <a class="tab" href="/">Home</a>
            <a class="tab" href="/basic">Basic</a>
            <a class="tab active" href="/advanced">Advanced</a>
            <a class="tab" href="/results">Results</a>
            <a class="tab" href="/upload">Upload</a>
        </div>
        <div class="spacer"></div>
        <a class="gh" href="https://github.com/cloudflare/telescope" target="_blank" rel="noreferrer">
            GitHub â†—
        </a>
    </nav>
    <section class="content">
        <h1>Advanced</h1>
        <h2>Configure all test parameters with advanced options.</h2>
        <form id="advanced-form">
            <!-- Basic Settings -->
            <div class="form-section">
                <h3>Basic Settings</h3>
                <div class="form-grid">
                    <label>
                        URL
                        <input name="url" type="url" placeholder="https://example.com" required />
                    </label>
                    <label>
                        Browser
                        <select name="browser" id="browserSelect" required>
                            <option value="">Select a browser...</option>
                            <option value="chrome">Chrome</option>
                            <option value="chrome-beta">Chrome Beta</option>
                            <option value="canary">Chrome Canary</option>
                            <option value="edge">Microsoft Edge</option>
                            <option value="safari">Safari</option>
                            <option value="firefox">Firefox</option>
                        </select>
                    </label>
                </div>
            </div>

            <!-- Viewport Settings -->
            <div class="form-section">
                <h3>Viewport Settings</h3>
                <div class="form-grid">
                    <label>
                        Width (pixels)
                        <input name="width" type="number" placeholder="1366" value="1366" min="1" />
                        <span>Default: 1366</span>
                    </label>
                    <label>
                        Height (pixels)
                        <input name="height" type="number" placeholder="768" value="768" min="1" />
                        <span>Default: 768</span>
                    </label>
                </div>
            </div>

            <!-- Network & Throttling -->
            <div class="form-section">
                <h3>Network & Throttling</h3>
                <div class="form-grid">
                    <label>
                        Connection Type
                        <select name="connectionType">
                            <option value="">No throttling (default)</option>
                            <option value="cable">Cable</option>
                            <option value="dsl">DSL</option>
                            <option value="4g">4G</option>
                            <option value="3g">3G</option>
                            <option value="3gfast">3G Fast</option>
                            <option value="3gslow">3G Slow</option>
                            <option value="2g">2G</option>
                            <option value="fios">FiOS</option>
                        </select>
                    </label>
                    <label>
                        CPU Throttle Factor
                        <input name="cpuThrottle" type="number" placeholder="e.g., 4" min="1" />
                        <span>Higher values = more throttling</span>
                    </label>
                </div>
            </div>

            <!-- Request Blocking -->
            <div class="form-section">
                <h3>Request Blocking</h3>
                <div class="form-grid">
                    <label class="form-full-width">
                        Block Domains
                        <input name="blockDomains" type="text" placeholder="ads.example.com, tracker.example.com" />
                        <span>Comma-separated list of domains to block</span>
                    </label>
                    <label class="form-full-width">
                        Block URLs (substring match)
                        <input name="block" type="text" placeholder="analytics.js, tracking.js" />
                        <span>Comma-separated list of URL substrings to block</span>
                    </label>
                </div>
            </div>

            <!-- Custom Headers & Cookies -->
            <div class="form-section">
                <h3>Custom Headers & Cookies</h3>
                <div class="form-grid">
                    <label class="form-full-width">
                        Headers (JSON)
                        <textarea name="headers" placeholder='{"Authorization": "Bearer token123", "X-Custom-Header": "value"}'></textarea>
                        <span>JSON object with custom headers</span>
                    </label>
                    <label class="form-full-width">
                        Cookies (JSON)
                        <textarea name="cookies" placeholder='{"name": "session", "value": "abc123"}'></textarea>
                        <span>JSON object or array for cookies. Example: {"name": "foo", "value": "bar"}</span>
                    </label>
                </div>
            </div>

            <!-- Authentication -->
            <div class="form-section">
                <h3>Authentication</h3>
                <div class="form-grid">
                    <label>
                        Username
                        <input name="authUsername" type="text" placeholder="username" />
                    </label>
                    <label>
                        Password
                        <input name="authPassword" type="password" placeholder="password" />
                    </label>
                    <label class="form-full-width">
                        Auth (JSON - alternative)
                        <textarea name="auth" placeholder='{"username": "user", "password": "pass"}'></textarea>
                        <span>Alternative: JSON object with username and password</span>
                    </label>
                </div>
            </div>

            <!-- Browser-Specific Options -->
            <div class="form-section">
                <h3>Browser-Specific Options</h3>
                <div class="form-grid">
                    <label class="form-full-width">
                        Chromium Flags
                        <input name="flags" type="text" placeholder="--disable-gpu, --disable-dev-shm-usage" />
                        <span>Comma-separated list of Chromium flags. See: <a href="https://peter.sh/experiments/chromium-command-line-switches/" target="_blank">Chromium flags reference</a></span>
                    </label>
                    <label class="form-full-width">
                        Firefox Preferences (JSON)
                        <textarea name="firefoxPrefs" placeholder='{"network.trr.mode": 2}'></textarea>
                        <span>Firefox only. JSON object with Firefox user preferences</span>
                    </label>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="form-section">
                <h3>Advanced Options</h3>
                <div class="form-grid">
                    <label>
                        Timeout (milliseconds)
                        <input name="timeout" type="number" placeholder="30000" value="30000" min="1000" />
                        <span>Default: 30000 (30 seconds)</span>
                    </label>
                    <label>
                        Frame Rate (FPS)
                        <input name="frameRate" type="number" placeholder="1" value="1" min="1" />
                        <span>Filmstrip frame rate. Default: 1</span>
                    </label>
                </div>
                <div class="form-grid" style="margin-top: 16px;">
                    <label class="checkbox-label">
                        <input name="disableJS" type="checkbox" />
                        Disable JavaScript
                    </label>
                    <label class="checkbox-label">
                        <input name="debug" type="checkbox" />
                        Debug Mode
                    </label>
                </div>
            </div>

            <!-- Output Options -->
            <div class="form-section">
                <h3>Output Options</h3>
                <div class="form-grid">
                    <label class="checkbox-label">
                        <input name="html" type="checkbox" />
                        Generate HTML Report
                    </label>
                    <label class="checkbox-label">
                        <input name="openHtml" type="checkbox" />
                        Open HTML Report (requires HTML option)
                    </label>
                    <label class="checkbox-label">
                        <input name="list" type="checkbox" />
                        Generate Results List
                    </label>
                    <label class="checkbox-label">
                        <input name="zip" type="checkbox" />
                        Zip Results
                    </label>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit">Run Test</button>
                <span id="status"></span>
            </div>
        </form>
        <div></div>
        <pre id="preview" style="margin:0; display:none;"></pre>
    </section>

    <script type="module">
        // Check for stored config from config page
        const storedConfig = sessionStorage.getItem('telescopeConfig');
        const autoSubmit = sessionStorage.getItem('telescopeAutoSubmit') === 'true';
        
        if (storedConfig) {
            try {
                const config = JSON.parse(storedConfig);
                prefillForm(config);
                
                // Clear sessionStorage
                sessionStorage.removeItem('telescopeConfig');
                sessionStorage.removeItem('telescopeAutoSubmit');
                
                // Auto-submit if flag is set
                if (autoSubmit) {
                    // Small delay to ensure form is filled
                    setTimeout(() => {
                        document.getElementById('advanced-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    }, 100);
                }
            } catch (error) {
                console.error('Error parsing stored config:', error);
            }
        }

        function prefillForm(config) {
            const form = document.getElementById('advanced-form');
            const options = config.options || {};
            const browserConfig = config.browserConfig || {};

            // Basic Settings
            if (config.url) setFieldValue(form, 'url', config.url);
            if (options.browser) setFieldValue(form, 'browser', options.browser);

            // Viewport Settings
            if (options.width) setFieldValue(form, 'width', options.width);
            if (options.height) setFieldValue(form, 'height', options.height);

            // Network & Throttling
            if (options.connectionType) setFieldValue(form, 'connectionType', options.connectionType);
            if (options.cpuThrottle) setFieldValue(form, 'cpuThrottle', options.cpuThrottle);

            // Request Blocking
            if (options.blockDomains && Array.isArray(options.blockDomains)) {
                setFieldValue(form, 'blockDomains', options.blockDomains.join(', '));
            }
            if (options.block && Array.isArray(options.block)) {
                setFieldValue(form, 'block', options.block.join(', '));
            }

            // Custom Headers & Cookies
            if (options.headers) {
                setFieldValue(form, 'headers', typeof options.headers === 'string' 
                    ? options.headers 
                    : JSON.stringify(options.headers, null, 2));
            }
            if (options.cookies) {
                setFieldValue(form, 'cookies', typeof options.cookies === 'string' 
                    ? options.cookies 
                    : JSON.stringify(options.cookies, null, 2));
            }

            // Authentication
            if (options.auth) {
                if (typeof options.auth === 'object') {
                    if (options.auth.username) setFieldValue(form, 'authUsername', options.auth.username);
                    if (options.auth.password) setFieldValue(form, 'authPassword', options.auth.password);
                    setFieldValue(form, 'auth', JSON.stringify(options.auth, null, 2));
                } else if (typeof options.auth === 'string') {
                    setFieldValue(form, 'auth', options.auth);
                }
            }

            // Browser-Specific Options
            if (options.flags) {
                setFieldValue(form, 'flags', Array.isArray(options.flags) 
                    ? options.flags.join(', ') 
                    : options.flags);
            }
            if (browserConfig.firefoxUserPrefs) {
                setFieldValue(form, 'firefoxPrefs', JSON.stringify(browserConfig.firefoxUserPrefs, null, 2));
            }

            // Advanced Options
            if (options.timeout) setFieldValue(form, 'timeout', options.timeout);
            if (options.frameRate) setFieldValue(form, 'frameRate', options.frameRate);
            if (options.disableJS) setCheckbox(form, 'disableJS', true);
            if (options.debug) setCheckbox(form, 'debug', true);

            // Output Options
            if (options.html) setCheckbox(form, 'html', true);
            if (options.openHtml) setCheckbox(form, 'openHtml', true);
            if (options.list) setCheckbox(form, 'list', true);
            if (options.zip) setCheckbox(form, 'zip', true);
        }

        function setFieldValue(form, name, value) {
            const field = form.querySelector(`[name="${name}"]`);
            if (field) {
                field.value = value;
            }
        }

        function setCheckbox(form, name, checked) {
            const checkbox = form.querySelector(`[name="${name}"]`);
            if (checkbox) {
                checkbox.checked = checked;
            }
        }
    </script>
</body>

</html>
